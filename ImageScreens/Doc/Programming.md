# Image Screens Programming Documentation

This documentation describes the implementation of the Image Screns mod,
including reasons why I implemented some things the way they are.
It is a useful resource if you want to learn about Satisfactory mod programming.

The documentation assumes you've read the Development part of the official
[Satisfactory Modding Documentation](https://docs.ficsit.app/satisfactory-modding/latest/index.html).

Most of the logic is implemented in Blueprints in the class `Build_Screen_Base`.


## Source language

The mod uses a combination of Blueprints and C++.

C++ is used because Blueprints do not support some functionality that the mod needs,
but that is available in C++:
- Download a text file over HTTP.
  See `UImageScreens_DownloadIndex` class.
- Access to low-level networking information, in particular

A few other things are possible in Blueprints, but awkward.
For this reason, advancing the slideshow state to the next image is implemented in C++.
See `UIS_SlideshowStateUtils::NextImage` method.


## Build\_Screen\_Base variables

The following variables are used to store state about a screen:
- `ScreenMesh`: contains reference to the mesh. Automatically generated by Unreal Editor.
- `AspectRatio`: Contains aspect ratio of each screen.
  Set manually in each child class.
- `ScreenSpec`: contains the data that the user can set for the screen.
  Contains primarily the URL of the texture or slideshow.
  This field is persistent and stored in a saved game.
- `JoinData`: transient data set by the server for newly joined clients.
  They use this field in addition to `ScreenSpec` to decide what to initially display.
  In particular, contains the active image of a running slideshow,
  which is normally replicated to all existing clients using the `Multi_LoadNewImage` event.
  Also contains error the server may have encountered while downloading the slideshow index file,
  which the client uses to initialize the `LastError` variable when joining a session.
- `LastError` contains an error, if any, that occurred while loading an image.
  This error can be different to each client.
  It is displayed in the widget UI.
- `SlideTimer` is the timer for ticking the slideshow, if slideshow is active.
  Only used on the server.
- `SlideDelay` remembers the delay, in seconds, between ticks of a slideshow.
  This is the delay that the `SlideTimer` uses.
  This variable is used to detect changes in the config.
- `SlideState` contains the list of slideshow images and index of the next image to show.
  Only used on the server.


## Multiplayer considerations

The slideshow is type of functionality that required special design for multiplayer:
- Players can interact with the screens.
  This requires the mod to use an RCO object.
- The mod loads custom textures.
  This is not possible on dedicated servers.
- The slideshow logic selects images in a random order,
  which must be the same on all connected clients.
  This requires the slideshow logic to run on the authority node.
  It then uses multicast events to inform clients which image to load.


### Events vs. properties

Most of the replication is implemented using replicated events, not properties.
Both options would have some advantages and disadvantages, I just chose what looked easier.

Using events makes it easier to implement atomic changes to some data
(which can all be arguments of the event, instead of separate replicated properties).
Extra code is needed to initialize the image screen on new clients
that join an existing multiplayer game.

Blueprint events and functions follow a naming convention
where the prefix shows how the event replicates:
- `Auth_` functions can only be called on the server.
  They can either be called by the RCO, or by another code that already runs on the server.
- `Client_` functions are only called on clients without authority - i.e. not on the DS and not on the host.
- `Multi_` functions are called on the server and are replicated to all clients,
  including the server itself.
- `Local_` functions can be called anywhere but only affect the local state.
  Often, a `Local_` function is called by a `Multi_` function with the same name.
  This allows the same code to be reused in replicated calls from the server and in local code.


### Server vs. client

All logic that changes state of a screen has to run on the node that has authority over the screen.
The widget UI thus uses the RCO object (`RCO_ImageScreens`) to invoke
the `Auth_SetNewImage` event on the server.
Logic that ticks the slideshow also runs just on the server.
The server can be a dedicated server, which means it has no rendering support,
so it cannot perform any actions that load textures or display data.

The server sends replicated events to clients which then process them to show images to the client.
These events include primarily `Multi_LoadNewImage`
and other minor events starting with `Multi_` (which are used to signal unusual state, e.g. empty or error).


## BeginPlay handling

When a save is loaded or when a client joins an existing multiplayer session,
`BeginPlay` will be called.

If we are on the server (which includes a singleplayer game, a host in MP or a dedicated server),
the server will either signal all clients to load an image using `Multi_LoadNewImage`,
or start the slideshow on the server.

If we are a client (i.e. not the host not the dedicated server),
`BeginPlay` will either switch to an error state (if the server error is set in `JoinData`),
or show the current image of a running slideshow (if set in `JoinData`),
or show the image from the `ScreenSpec`.
This puts the screen to the same state as screens on existing clients,
and makes up for any replication events that the server sent before this client joined.

`BeginPlay` is also called when placing a brand new image screen.


## Server logic

The server decides which images to display, both when displaying a static image
and when sequencing through a slideshow.
The server notifies all clients with `Multi_LoadNewImage` each time a new image should be displayed.

When a slideshow is active, the server is running a timer to tick loading of the next image in sequence.
The handle is stored in the `SlideTimer` variable.
The order of images in the slideshow will be shuffled each time we're starting to run
over the whole sequence, including when the slideshow is starting for the first time.


## Error handling

Because some part of the logic runs on the server
(basic error checks for the URL and slideshow processing)
and some part on the client (loading images),
errors can happen both on the server and on the client.
This in particular includes failure to download the slideshow index or the texture from the URL.

For this reason, the error handling is a bit more complex:
the server replicates the error message to clients using `Multi_SetError`.
Clients will then store the error in the `LastError` variable.
They will also update the same variable when the client encounters an error,
in which case each client may see a different error.
The `LastError` variable thus contains information about the last error encountered
either on the sevrer or on this particular client.

The error has only visual consequences:
if an error occurred, the screen shows a special texture
and the widget UI displays the last error.


## Configuration

Mod configuration is implemented in blueprints.

Because it is the server (host or DS) that is controlling slideshows,
it is the configuration on the server that effects what the clients see.
Changing the slideshow options on clients will have no effect.

There is some logic in `Auth_SlideshowConfigChanged` that attempts to minimize number of changes made
when the config changed event is triggered, but no actual change has been made to the config.

Right now, each screen installs its own handler for the config change events.
I'm sure this could be optimized more.
